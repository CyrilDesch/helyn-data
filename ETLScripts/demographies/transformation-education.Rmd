```{r load-xlsx, echo=TRUE}
# Charger le package readxl
library(readxl)

# Charger les données pour 2010
data2010 <- read_excel("/home/hugo/helyn-data/rawData/demographies/Education2010.xlsx",skip = 3)

# Charger les données pour 2021
data2021 <- read_excel("/home/hugo/helyn-data/rawData/demographies/Education2021.xlsx",skip = 3)
```

```{r rename-colomns, echo=TRUE}
colnames(data2010) <- c(
  "Code_Insee",
  "Libelle",
  "Nb_non_scolarises_15ans_plus_2010",
  "Part_non_peu_diplomes_2010",
  "Part_bepc_brevet_2010",
  "Part_cap_bep_2010",
  "Part_bac_2010"
)

# Vérifiez les nouveaux noms
colnames(data2010)

# Renommer les colonnes pour 2021
colnames(data2021) <- c(
  "Code_Insee",
  "Libelle",
  "Part_BAC5_plus_2021",
  "Nb_non_scolarises_2010",
  "Part_BAC2_2021",
  "Part_BAC3_4_2021",
  "Part_non_peu_diplomes_2021",
  "Part_bepc_brevet_2021",
  "Part_CAP_BEP_2021",
  "Part_BAC_2021"
)

# Vérifiez les nouveaux noms
colnames(data2021)
```

```{r reorder-columns, echo=TRUE}
# Réorganiser les colonnes pour 2010
data2010 <- data2010 %>%
  select(
    Code_Insee,
    Libelle,
    Nb_non_scolarises_15ans_plus_2010, # Nombre total
    Part_non_peu_diplomes_2010,        # Part non ou peu diplômés
    Part_bepc_brevet_2010,             # Part BEPC/Brevet
    Part_cap_bep_2010,                 # Part CAP/BEP
    Part_bac_2010                      # Part Bac
  )

# Vérifiez l'ordre des colonnes pour 2010
colnames(data2010)

# Réorganiser les colonnes pour 2021
data2021 <- data2021 %>%
  select(
    Code_Insee,
    Libelle,
    Nb_non_scolarises_2010,            # Nombre total (attention, appartient à 2010)
    Part_non_peu_diplomes_2021,        # Part non ou peu diplômés
    Part_bepc_brevet_2021,             # Part BEPC/Brevet
    Part_CAP_BEP_2021,                 # Part CAP/BEP
    Part_BAC_2021,                     # Part Bac
    Part_BAC2_2021,                    # Part Bac+2
    Part_BAC3_4_2021,                  # Part Bac+3/+4
    Part_BAC5_plus_2021                # Part Bac+5 et plus
  )

# Vérifiez l'ordre des colonnes pour 2021
colnames(data2021)
```

```{r filter-data, echo=TRUE}
# Charger les packages nécessaires
library(dplyr)

# Nettoyer les données pour 2010
data2010_clean <- data2010 %>%
  filter(
    !is.na(Code_Insee), # Supprimer les lignes où le Code Insee est NA
    Nb_non_scolarises_15ans_plus_2010 > 0, # Vérifier que le nombre de non-scolarisés est positif
    Part_non_peu_diplomes_2010 >= 0 & Part_non_peu_diplomes_2010 <= 100, # Vérifier les pourcentages
    Part_bepc_brevet_2010 >= 0 & Part_bepc_brevet_2010 <= 100,
    Part_cap_bep_2010 >= 0 & Part_cap_bep_2010 <= 100,
    Part_bac_2010 >= 0 & Part_bac_2010 <= 100
  )

# Suppression de doublons pour 2010
data2010_clean <- data2010_clean %>%
  distinct(Code_Insee, .keep_all = TRUE)

# Nettoyer les données pour 2021
data2021_clean <- data2021 %>%
  filter(
    !is.na(Code_Insee), # Supprimer les lignes où le Code Insee est NA
    Part_BAC5_plus_2021 >= 0 & Part_BAC5_plus_2021 <= 100, # Vérifier les pourcentages
    Part_BAC2_2021 >= 0 & Part_BAC2_2021 <= 100,
    Part_BAC3_4_2021 >= 0 & Part_BAC3_4_2021 <= 100,
    Part_non_peu_diplomes_2021 >= 0 & Part_non_peu_diplomes_2021 <= 100,
    Part_bepc_brevet_2021 >= 0 & Part_bepc_brevet_2021 <= 100,
    Part_CAP_BEP_2021 >= 0 & Part_CAP_BEP_2021 <= 100,
    Part_BAC_2021 >= 0 & Part_BAC_2021 <= 100
  )

# Suppression de doublons pour 2021
data2021_clean <- data2021_clean %>%
  distinct(Code_Insee, .keep_all = TRUE)

# Vérifier les structures et les aperçus après nettoyage
str(data2010_clean)
str(data2021_clean)
```

```{r save-cleaned-data, echo=TRUE}
# Chemin du dossier de destination
output_dir <- "/home/hugo/helyn-data/cleanData/demographies"

# Créer le dossier si nécessaire
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}

# Visualiser les datas
head(data2010_clean)
head(data2021_clean)

# Sauvegarder les données nettoyées en CSV
write.csv(data2010_clean, file.path(output_dir, "Education2010_clean.csv"), row.names = FALSE)
write.csv(data2021_clean, file.path(output_dir, "Education2021_clean.csv"), row.names = FALSE)

# Message de confirmation
cat("Les fichiers nettoyés ont été enregistrés dans : ", output_dir, "\n")
```