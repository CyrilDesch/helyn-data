---
title: "Try"
output: html_document
---

```{r setup, include=FALSE}
library(readxl)
library(here)
library(dplyr)
library(corrplot)
```

```{r}
donnees <- read.csv(here("cleanData", "merge_data_all_years.csv"))

# Affichage du nom des colonnes
str(donnees)
head(donnees)
```

```{r analyse-data}
vote_cols <- c(
  "pourcentage_voix_votant_eg",
  "pourcentage_voix_votant_g",
  "pourcentage_voix_votant_c",
  "pourcentage_voix_votant_d",
  "pourcentage_voix_votant_ed"
)

vote_cols2 <- c(
  "votants", 
  "non_exp", 
  "voix_eg", 
  "pourcentage_voix_votant_eg",
  "voix_g", 
  "pourcentage_voix_votant_g",
  "voix_c", 
  "pourcentage_voix_votant_c",
  "voix_d", 
  "pourcentage_voix_votant_d",
  "voix_ed",
  "pourcentage_voix_votant_ed"
)

df_numeric <- donnees %>%
  select_if(is.numeric)

dem_cols <- setdiff(names(df_numeric), vote_cols2)

# On filtre les colonnes "vote" et "demographie" dans df_numeric
df_vote <- donnees %>%
  select(any_of(vote_cols)) %>%
  select_if(is.numeric)  # Assure qu'on ne garde que des colonnes numériques

df_demo <- donnees %>%
  select(any_of(dem_cols)) %>%
  select_if(is.numeric)  # Idem pour la démographie

# cor(x, y) calcule les corrélations entre chaque colonne de x et chaque colonne de y
corr_vote_demo <- cor(df_vote, df_demo, use = "pairwise.complete.obs")

# Afficher la matrice
corr_vote_demo

corrplot(corr_vote_demo, method = "color", is.corr = FALSE)

# On la transforme en tableau
corr_table <- as.data.frame(as.table(corr_vote_demo))

# On nomme clairement les colonnes
colnames(corr_table) <- c("VarVote", "VarDemo", "Correlation")

# On trie selon la valeur absolue du coefficient
corr_table_sorted <- corr_table[order(abs(corr_table$Correlation), decreasing = TRUE), ]

# On affiche les 10 plus fortes corrélations
head(corr_table_sorted, 40)
```

```{r cor-age-sexe}
prop_cols <- c(
  "prop_25",      # proportion de la population ayant 25 ans ?
  "prop_25_64",   # proportion 25-64 ans
  "prop_65",      # proportion 65+ ans
  "proportion_h", # proportion d'hommes
  "proportion_f"  # proportion de femmes
  # ... ajoutez d'autres variables de proportions si besoin
)

df_prop <- donnees %>%
  select(any_of(prop_cols)) %>%
  select_if(is.numeric)

corr_vote_prop <- cor(df_vote, df_prop, use = "pairwise.complete.obs")
corr_vote_prop

corrplot(corr_vote_prop, method = "color", is.corr = FALSE)

corr_table_prop <- as.data.frame(as.table(corr_vote_prop))
colnames(corr_table_prop) <- c("VarVote", "VarProp", "Correlation")

# Tri par ordre décroissant d'absolu de corrélation
corr_table_prop_sorted <- corr_table_prop[order(abs(corr_table_prop$Correlation), 
                                                decreasing = TRUE), ]

# Affichez par exemple les 20 premières lignes 
head(corr_table_prop_sorted, 20)
```

```{r analyse-data}
# Tri par variable démographique (group_by) 
corr_table_sorted_by_demo <- corr_table %>%
  group_by(VarDemo) %>%
  arrange(desc(abs(Correlation)), .by_group = TRUE)

# Affiche toutes les corrélations, triées à l'intérieur de chaque VarDemo
corr_table_sorted_by_demo
```

```{r all-regressions, echo=TRUE, warning=FALSE, message=FALSE}
# -------------------------------
# Chargement des librairies
# -------------------------------
library(ggplot2)

# -------------------------------
# 1. pourcentage_voix_votant_eg ~ part_employes
# -------------------------------
mod_eg_employes <- lm(pourcentage_voix_votant_eg ~ part_employes, data = donnees)
summary(mod_eg_employes)

ggplot(donnees, aes(x = part_employes, y = pourcentage_voix_votant_eg)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Régression linéaire : EG ~ part_employes",
    x = "Part des employés",
    y = "% Voix EG"
  )

# -------------------------------
# 2. pourcentage_voix_votant_c ~ part_employes
# -------------------------------
mod_c_employes <- lm(pourcentage_voix_votant_c ~ part_employes, data = donnees)
summary(mod_c_employes)

ggplot(donnees, aes(x = part_employes, y = pourcentage_voix_votant_c)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Régression linéaire : C ~ part_employes",
    x = "Part des employés",
    y = "% Voix C"
  )

# -------------------------------
# 3. pourcentage_voix_votant_eg ~ part_ouvriers
# -------------------------------
mod_eg_ouvriers <- lm(pourcentage_voix_votant_eg ~ part_ouvriers, data = donnees)
summary(mod_eg_ouvriers)

ggplot(donnees, aes(x = part_ouvriers, y = pourcentage_voix_votant_eg)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Régression linéaire : EG ~ part_ouvriers",
    x = "Part des ouvriers",
    y = "% Voix EG"
  )

# -------------------------------
# 4. pourcentage_voix_votant_c ~ part_ouvriers
# -------------------------------
mod_c_ouvriers <- lm(pourcentage_voix_votant_c ~ part_ouvriers, data = donnees)
summary(mod_c_ouvriers)

ggplot(donnees, aes(x = part_ouvriers, y = pourcentage_voix_votant_c)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Régression linéaire : C ~ part_ouvriers",
    x = "Part des ouvriers",
    y = "% Voix C"
  )

# -------------------------------
# 5. pourcentage_voix_votant_ed ~ part_bac5_plus
# -------------------------------
mod_ed_bac5plus <- lm(pourcentage_voix_votant_ed ~ part_bac5_plus, data = donnees)
summary(mod_ed_bac5plus)

ggplot(donnees, aes(x = part_bac5_plus, y = pourcentage_voix_votant_ed)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Régression linéaire : ED ~ part_bac5_plus",
    x = "Part Bac+5 et plus",
    y = "% Voix ED"
  )

# -------------------------------
# 6. pourcentage_voix_votant_c ~ part_non_peu_diplomes
# -------------------------------
mod_c_peudipl <- lm(pourcentage_voix_votant_c ~ part_non_peu_diplomes, data = donnees)
summary(mod_c_peudipl)

ggplot(donnees, aes(x = part_non_peu_diplomes, y = pourcentage_voix_votant_c)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Régression linéaire : C ~ part_non_peu_diplomes",
    x = "Part non/peu diplômés",
    y = "% Voix C"
  )

# -------------------------------
# 7. pourcentage_voix_votant_ed ~ part_bac3_4
# -------------------------------
mod_ed_bac3_4 <- lm(pourcentage_voix_votant_ed ~ part_bac3_4, data = donnees)
summary(mod_ed_bac3_4)

ggplot(donnees, aes(x = part_bac3_4, y = pourcentage_voix_votant_ed)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Régression linéaire : ED ~ part_bac3_4",
    x = "Part Bac+3/4",
    y = "% Voix ED"
  )

# -------------------------------
# 8. pourcentage_voix_votant_eg ~ part_non_peu_diplomes
# -------------------------------
mod_eg_peudipl <- lm(pourcentage_voix_votant_eg ~ part_non_peu_diplomes, data = donnees)
summary(mod_eg_peudipl)

ggplot(donnees, aes(x = part_non_peu_diplomes, y = pourcentage_voix_votant_eg)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Régression linéaire : EG ~ part_non_peu_diplomes",
    x = "Part non/peu diplômés",
    y = "% Voix EG"
  )

# -------------------------------
# 9. pourcentage_voix_votant_ed ~ part_cap_bep
# -------------------------------
mod_ed_capbep <- lm(pourcentage_voix_votant_ed ~ part_cap_bep, data = donnees)
summary(mod_ed_capbep)

ggplot(donnees, aes(x = part_cap_bep, y = pourcentage_voix_votant_ed)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Régression linéaire : ED ~ part_cap_bep",
    x = "Part CAP/BEP",
    y = "% Voix ED"
  )

# -------------------------------
# 10. pourcentage_voix_votant_g ~ nb_logements_sociaux
# -------------------------------
mod_g_logsoc <- lm(pourcentage_voix_votant_g ~ nb_logements_sociaux, data = donnees)
summary(mod_g_logsoc)

ggplot(donnees, aes(x = nb_logements_sociaux, y = pourcentage_voix_votant_g)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Régression linéaire : G ~ nb_logements_sociaux",
    x = "Nombre de logements sociaux",
    y = "% Voix G"
  )
```