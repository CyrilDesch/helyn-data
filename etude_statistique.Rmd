---
title: "Helyn - Étude statistiques"
subtitle: "Prédire les résultats des élections présidentielles françaises d'un bureau de vote"
author: "D'après Cyril Deschamps, Etienne Ducros, Hugo Brun et Lennon Herrmann"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true           # Ajoute une table des matières
    toc_depth: 3        # Définit la profondeur de la table des matières
    number_sections: true  # Numérote les sections du rapport
    fig_caption: true   # Ajoute des légendes aux figures
  pdf_document: default  # Si un PDF est souhaité
---

<style>
body {text-align: justify}
</style>

--- 

> **TODO** :  
> - Vérifier qu'il n'y a plus de TODO dans le fichier.  
> - Ajouter des images, diagrammes et extraits de code.  
> - Ajouter des échantillons de données pour expliciter chaque étape.    

```{r echo = FALSE, warning = FALSE, message = FALSE }
# Not display
library(readr)
library(gt)
library(dplyr)
library(ggplot2)
library(tidyr)
library(caret)
library(ranger)
library(doParallel)
library(nnet)
```

--- 

## Introduction

### Problématique
Prédire les résultats d'éléctions présidentielles française d'un bureau de vote.

### Cadre théorique 
Les préférences politiques des individus peuvent être façonnées par des variables socio-démographiques telles que l’âge, le niveau d’éducation, la situation économique ou encore le lieu de résidence. Plusieurs cadres théoriques permettent de formuler des hypothèses sur ces influences potentielles.

La **théorie de la socialisation politique** suppose que des facteurs comme l’âge, le genre et la composition familiale jouent un rôle dans la formation des opinions politiques. Par exemple, on pourrait s’attendre à ce que les jeunes adultes soient plus attirés par des idées progressistes, tandis que les générations plus âgées privilégient des positions conservatrices, influencées par leurs expériences passées.

Les théories liées au **clivage de classe sociale**, inspirées par les travaux de Karl Marx et Pierre Bourdieu, postulent que la position des individus dans la hiérarchie socio-professionnelle peut orienter leurs préférences politiques. Les individus occupant des emplois manuels ou précaires pourraient être davantage sensibles aux discours en faveur de la justice sociale, tandis que les catégories socio-professionnelles supérieures seraient plus réceptives aux politiques favorisant l'investissement et la stabilité économique.

Le **capital culturel**, tel que défini par Pierre Bourdieu, pourrait également jouer un rôle dans le comportement électoral. Les niveaux de qualification peuvent influencer la perception des enjeux politiques : les personnes disposant d’un diplôme supérieur pourraient privilégier des valeurs universalistes et libérales, alors que les moins diplômés pourraient être plus sensibles aux discours protectionnistes ou nationalistes.

La **théorie du contexte géographique** met en avant l’importance du lieu de vie et des interactions sociales locales sur les comportements politiques. Les caractéristiques urbaines et rurales, la proportion de logements sociaux ou encore l'ancienneté des constructions peuvent être des indicateurs pertinents pour comprendre les dynamiques électorales locales.

La **théorie de la privation relative** suggère que les inégalités perçues entre les attentes des individus et leur situation réelle peuvent les amener à soutenir des mouvements politiques contestataires. Des indicateurs comme le taux de pauvreté, le niveau de vie ou la précarité de l'emploi pourraient refléter ce sentiment de frustration.

Enfin, la **théorie du choix rationnel** propose que les électeurs adoptent des comportements stratégiques, en cherchant à maximiser leurs bénéfices individuels à travers leurs choix politiques. Par exemple, les propriétaires immobiliers ou les ménages vivant seuls pourraient orienter leurs votes en fonction des politiques perçues comme avantageuses ou défavorables à leurs intérêts.

### Modèle de l’étude
Quel lien existe entre les différents facteurs socio-démographiques influencent-ils les choix politiques des citoyens ?

### Objectifs de l’étude
L’objectif est d'explorer ces hypothèses théoriques en s'appuyant sur des données socio-démographiques et électorales de plusieurs années. Cette étape théorique permet de poser les bases d’une analyse empirique qui pourra confirmer ou infirmer ces hypothèses en fonction des observations. Nous étudierons les liens au travers de différentes techniques d'analyse statistiques.

---

## Identification et récupération des données

### Élections par bureau de vote

D’après le cadre théorique, la première étape consiste à collecter les résultats des élections présidentielles. Pour enrichir notre jeu de données, nous avons choisi de les détailler au niveau des bureaux de vote. La plateforme *data.gouv.fr* nous donne accès à ce type de données. Lors de chaque élection, environ 70 000 bureaux de vote partagent leurs résultats. Nous limiterons toutefois notre étude aux trois dernières élections présidentielles (2012, 2017 et 2022), ce qui sera largement suffisant pour répondre à notre problématique.  

De plus, nous nous concentrerons uniquement sur les bureaux de vote situés en France métropolitaine afin de simplifier la visualisation des données sur une carte. Cette restriction n’a qu’un faible impact sur la représentativité globale du jeu de données.


### Données socio-démographiques

À partir du cadre théorique, nous avons identifié plusieurs groupes de facteurs socio-démographiques susceptibles d'influencer les orientations politiques des individus :

- **Facteurs démographique** : ce groupe comprend des variables telles que l’âge, le genre et la composition familiale. Ces éléments permettent d'évaluer l’impact de la socialisation politique, notamment l'influence des générations et des expériences de vie sur le comportement électoral.

- **Facteurs travail et revenus** : ces variables incluent la catégorie socio-professionnelle, le type d'emploi (salarié ou indépendant), le taux d'activité et le niveau de vie. Elles permettent d'explorer le rôle des disparités économiques et de la hiérarchie sociale sur les préférences politiques, en lien avec la théorie du clivage de classe.  

- **Facteurs éducation** : le niveau de diplôme et les qualifications constituent des indicateurs clés du capital culturel. Ces données sont utiles pour comprendre la manière dont l'accès au savoir et la formation influencent la perception des enjeux politiques.

- **Facteurs lieu de vie** : ce groupe comprend des variables liées au lieu de résidence, telles que la répartition urbaine ou rurale, la proportion de logements sociaux, et l’ancienneté des constructions. Ces éléments permettent d'examiner l'impact du contexte spatial et des interactions sociales locales sur le vote.  

- **Facteurs conditions de vie** : le taux de pauvreté, la précarité de l’emploi et la composition des ménages permettent de mesurer le sentiment de privation relative et son effet potentiel sur l'adhésion à des mouvements politiques contestataires.  

- **Facteurs mode de vie** : certaines variables, comme la propriété immobilière ou la structure des ménages (par exemple, vivre seul ou en famille), peuvent refléter des comportements électoraux stratégiques, en lien avec des choix rationnels visant à préserver ou à optimiser une situation personnelle.  

Certaines de ces données ont été directement récupérées sur le site de l'INSEE, via des études ou des cartes interactives avec export de données (par exemple, statistiques-locales.insee.fr). Nous avons rencontré des difficultés pour obtenir des données complètes et précises, par exemple pour l'âge moyen des habitants. En effet, la donnée était séparée en tranches d'âge, ce qui ne correspondait pas exactement à notre besoin. De plus, ces tranches d'age étaient réduites à moins de 25 ans, 25-64 ans et plus de 65 ans. Nous avons donc dû nous contenter de ces données, en espérant qu'elles soient suffisantes pour notre étude.

Nous avons aussi rencontré des problèmes pour obtenir des données sur le niveau d'études, qui n'étaient pas disponibles pour toutes les années. Pour ces paramètres, nous avons choisi des laisser ces valeurs manquantes plutôt que de les calculer avec des valeurs approximatives. Cela nous permet de conserver une certaine rigueur dans notre analyse, nous laissant toujours la possibilité de revenir sur ce choix et d'imputer les données si besoin.

Les données socio-démographiques concernant les communes d'outre-mer n'ont pas été incluses dans notre étude, car il manquait trop de données pour être comparables avec celles de la France métropolitaine. Cela aurait introduit un biais dans notre analyse, en mélangeant des données provenant de contextes socio-économiques différents.

La grande majorité de ces données étant regroupées par commune, nous avons décidé de les répartir proportionnellement entre les bureaux de vote en fonction du nombre de votants.

Nous aurions aussi aimmé utiliser d'autres données, ou des jeux plus précis pour notre analyse, mais ces données étaient rapportés aux départements ou région et non par commune. Cela aurait nécessité un travail de fusion et de répartition des données plus complexe, que nous n'avons pas jugé utile pour notre étude.

En revanche, la collecte des données concernant les revenus, le lieu de vie et les conditions de vie a été plus complexe. Ces données sont fournies sous forme de « carreaux » géographiques de 200 mètres de côté. Il a donc été nécessaire de récupérer les contours géographiques des bureaux de vote, de convertir et harmoniser les formats de coordonnées (CRS), puis de fusionner ces ensembles de données. La librairie R sf a été utilisée pour effectuer ces opérations, notamment en croisant les carreaux de 200 mètres avec les contours des bureaux de vote. Cette tâche s'est avérée chronophage en raison du coût computationnel élevé des calculs nécessaires pour chaque opération. Certaines données ont dû être additionnées, d'autres moyennées. Une vérification finale a montré une perte de seulement 0,01 % des données, ce qui constitue un excellent résultat pour ce type de fusion géographique.



--- 

## Nettoyage et fusion des données 

Concernant le nettoyage des données, plusieurs étapes ont été nécessaires pour garantir la qualité et la cohérence des informations. Les données électorales et socio-démographiques ont été collectées auprès de différentes sources, nécessitant une harmonisation des formats et des variables.
Nous avons d'abord sélectionné les colonnes pertinentes pour notre étude, en éliminant les doublons et les variables inutiles. Un travail de normalisation a été effectué pour uniformiser les noms des colonnes et faciliter les opérations de fusion et de jointure.
Les données ont été vérifiées afin d’éviter les valeurs aberrantes et garantir leur cohérence. Certaines transformations ont également été effectuées pour faciliter la visualisation et les rendre compatibles avec notre modèle d'analyse.

Le point de centralisation des données est le *"code bureau de vote"*, un identifiant unique attribué à chaque bureau de vote.

### Traitement des données électorales  
Pour les résultats des élections, il a d'abord été nécessaire de transformer la liste des votes par candidat dans chaque bureau de vote en catégories agrégées correspondant aux principaux courants politiques : Extrême Gauche, Gauche, Centre, Droite et Extrême Droite. Cette étape permet de simplifier l'analyse des tendances politiques tout en conservant une granularité suffisante.

Une colonne "Code" a été ajoutée en combinant les codes du département, de la commune et du bureau de vote, ce qui facilite la fusion avec d'autres jeux de données. Certaines colonnes, telles que les noms des départements ou les pourcentages inutiles (ex. : % Abstentions/Inscrits), ont été supprimées pour alléger le jeu de données. Une colonne "nonExp" a été créée pour regrouper les bulletins blancs et nuls. Cette information nous aide à mieux comprendre les niveaux de participation et de contestation.

Les données finales ont été organisées de manière à regrouper les colonnes liées à chaque courant politique, en mettant en avant les variables principales (comme les pourcentages par votant, inscrits et suffrages exprimés).

Un extrait des données nettoyées et organisées est présenté ci-dessous :

```{r echo = FALSE, warning = FALSE, message = FALSE }

library(readxl)
library(gt)
data <- read_excel("./cleanData/elections/resultats-burvot-t1-presidentielle_2022.xlsx")
head(data, 3) %>%
  gt()

```

### Traitement des données socio-démographiques
Concernant les facteurs socio-démographiques, certaines données étaient déjà disponibles au niveau des bureaux de vote, tandis que d’autres étaient regroupées au niveau communal. Ces dernières ont été réparties entre les bureaux de vote en suivant une répartition proportionnelle basée sur le nombre de votants, comme décrit précédemment.

Afin de préparer la visualisation de nos données sur des cartes, nous avons conservé un fichier spatial au format GeoJSON contenant les contours des bureaux de vote, identifiés par l'ID code_bureau_vote. Ce fichier, d'une taille de 600 Mo, a été isolé pour éviter de ralentir le traitement des données lors des analyses statistiques. En cas de besoin, il peut être facilement fusionné avec notre jeu de données pour générer des visualisations cartographiques.

Ces étapes ont permis de disposer d’un jeu de données homogène et prêt pour l'analyse statistique des corrélations entre les variables socio-démographiques et les résultats électoraux. Voici un échantillon des 72 colonnes finales :

```{r echo = FALSE, warning = FALSE, message = FALSE }
library(readr)
library(gt)
##data <- read_csv("./cleanData/merge_data_all_years.csv", show_col_types = FALSE)
data <- read_csv("./cleanData/merge_data_all_years.csv", show_col_types = FALSE)

data <- data %>%
  filter((voix_eg + voix_g + voix_c + voix_d + voix_ed) != 0)

head(data, 3) %>% 
  gt()
```

--- 

## Data Mining Descriptif (analyse statistique simple chi2 et tout)

L'analyse des données doit être la plus précise possible. Pour cela, nous avons choisi de créer un jeu de données intermédiaire qui élimine la duplication des bureaux de vote sur plusieurs années. Nous sélectionnerons aléatoirement une seule observation par bureau de vote parmi différentes années afin d’éviter un biais de similitude. En effet, un bureau ayant historiquement voté à droite a de fortes chances de continuer à voter de la même manière, ce qui pourrait fausser l’analyse si nous incluons plusieurs observations temporelles sans ajustement.  

Nous ajoutons également une variable score comprise entre 0 et 1, qui indique l’orientation politique moyenne :  
- 0 correspond à l’extrême gauche,  
- 0.5 représente le centre,  
- 1 correspond à l’extrême droite.  
```{r}
data <- data %>%
  mutate(
    score_orientation = round(
        (voix_ed * 1 + voix_d * 0.75 + voix_c * 0.5 + voix_g * 0.25 + voix_eg * 0) /
          (voix_eg + voix_g + voix_c + voix_d + voix_ed),
        2
      )
  )

score_moyen <- mean(data$score_orientation)

# Intervalle de confiance
n <- length(data$score_orientation)
score_var <- var(data$score_orientation)
alpha <- 0.05
quant_stud <- qt(1-alpha/2, df=n-1)
borne_inf <- score_moyen - quant_stud * sqrt(score_var/n)
borne_sup <- score_moyen + quant_stud * sqrt(score_var/n)
paste(borne_inf, "<", score_moyen, "<", borne_sup)
```
Cela indique que l’orientation politique française actuelle se situe plutôt au centre-droit.

Notre objectif initial est d'explorer la corrélation entre le niveau de richesse et l'orientation politique. Les politiques de droite étant souvent perçues comme plus favorables aux personnes disposant de revenus élevés, il est raisonnable d’anticiper une corrélation positive entre un haut niveau de richesse et un soutien aux partis de droite.

### Richesse

N'ayant pas de données sur le niveau de vie en 2012, nous ne séléctionnerons pas de datas sur cette année. Voici le dataset que nous utiliserons:

```{r echo = FALSE, warning = FALSE, message = FALSE }
analys_data <- data %>%
  filter(annees != "2008-2012") %>%
  group_by(code_bureau_vote) %>%
  slice_sample(n = 1) %>%
  ungroup() %>%
  sample_frac(size = 1/7)

head(analys_data, 3) %>% 
  gt()
```

  
Observons rapidement la répartition des richesses en fonction des votes:
  
```{r echo = FALSE, warning = FALSE, message = FALSE }
lims <- quantile(analys_data$niveau_vie_total, probs = c(0.01, 0.99), na.rm = TRUE)

analys_data_clean <- analys_data %>%
  filter(
    niveau_vie_total >= lims[1],
    niveau_vie_total <= lims[2]
  )

# EG
ggplot(analys_data_clean, aes(x = pourcentage_voix_votant_eg, y = niveau_vie_total)) +
  geom_point(alpha = 0.7, color = "blue") +
  labs(
    title = "Relation entre Niveau de vie et % Voix EG",
    x = "Pourcentage de voix votant EG",
    y = "Niveau de vie total"
  ) +
  theme_minimal()

# ED
ggplot(analys_data_clean, aes(x = pourcentage_voix_votant_ed, y = niveau_vie_total)) +
  geom_point(alpha = 0.7, color = "blue") +
  labs(
    title = "Relation entre Niveau de vie et % Voix ED",
    x = "Pourcentage de voix votant ED",
    y = "Niveau de vie total"
  ) +
  theme_minimal()
```

On constate qu'effectivement le niveau de vie semble impacter le pourcentage de voix d'extrême gauche mais n'explique pas tout. Pour ce qui est de l'extrème droite, on observe une grande répartition donc le niveau de vie ne semble pas un facteur premier. Mais il y a tout de même cette tendance, ce qui laisse penser que la pauvreté pousse à voté dans les extrêmes.   

Comparons maintenant avec notre score :  

```{r echo = FALSE, warning = FALSE, message = FALSE }

ggplot(analys_data_clean, aes(x = score_orientation, y = niveau_vie_total)) +
  geom_point(alpha = 0.7, color = "blue") +
  scale_x_continuous(
    limits = c(0, 1),                # Force l'axe X entre 0 et 1
    breaks = seq(0, 1, by = 0.1)     # Gradations tous les 0.1
  ) +
  labs(
    title = "Relation entre le niveau de vie et l'orientation de vote",
    x = "Score (0 = Extrême gauche, 1 = Extrême droite)",
    y = "Niveau de vie total"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),  # Centre le titre
    text = element_text(size = 12)           # Ajuste la taille du texte
  )
```
Nous cherchons une diagonale allant de l'angle inférieur gauche vers l'angle supérieur droit. Ce n'est pas le cas ici, ce qui indique que l'influence de la richesse sur les votes n'est pas significative lorsqu'elle est observée isolément. En revanche, notre théorie est confirmée : plus le niveau de richesse est faible, plus les votes pour les extrêmes augmentent.

En conclusion, la richesse permet simplement d'expliquer qu'un niveau de vie bas est associé à une probabilité plus élevée de vote pour les extrêmes.

### Recherche globale

#### Par visualisation

Comme nous venons de le voir, il est intéressant de ploter notre score face à nos différentes données, nous allons donc tous les tester rapidement et essayer d'observer.

```{r}
analys_data_long <- analys_data_clean %>%
  select(score_orientation, where(is.numeric)) %>%
  select(-contains("voix")) %>%
  pivot_longer(
    cols = -score_orientation,
    names_to = "variable",
    values_to = "value"
  )

p <- ggplot(analys_data_long, aes(x = score_orientation, y = value)) +
  geom_point(alpha = 0.7, color = "blue") +
  facet_wrap(~ variable, scales = "free_y") +
  labs(
    title = "Score d'orientation vs. autres variables",
    x = "Score (0 = Extrême gauche, 1 = Extrême droite)",
    y = "Variables"
  ) +
  theme_minimal()

# Export en image pour une meilleur lecture
ggsave("scatterplot_matrix.png", plot = p, width = 12, height = 8, dpi = 300)

p
```

Cette matrice de graphiques en dispersions nous donne un bonne aperçu de quel variables seront intéressantes à étudier. 

#### Par un modèle

```{r eval=FALSE}
# Préparation des données
df_model <- data %>%
 group_by(code_bureau_vote) %>%
 slice_sample(n = 1) %>%
 ungroup() %>%
 select(where(is.numeric)) %>%
 select(-contains("voix"), -contains("non_exp")) %>%
 filter(!is.na(score_orientation))

nzv <- nearZeroVar(df_model, saveMetrics = TRUE)
df_model <- df_model[, !nzv$nzv]

preProcValues <- preProcess(df_model, method = "medianImpute")
df_model <- predict(preProcValues, df_model)

num_cores <- parallel::detectCores() - 1
cl <- makeCluster(num_cores)
registerDoParallel(cl)

train_ctrl <- trainControl(
 method        = "repeatedcv",
 number        = 5,
 repeats       = 3,
 verboseIter   = FALSE,
 allowParallel = TRUE
)

tune_grid <- expand.grid(
 mtry          = c(2, 4, 6, 8),
 splitrule     = c("variance", "extratrees"),
 min.node.size = c(5, 10, 15)
)

df_model <- as.data.frame(df_model)
X <- df_model[, setdiff(names(df_model), "score_orientation")]
Y <- df_model$score_orientation

set.seed(123)
rf_model <- train(
 x          = X,
 y          = Y,
 method     = "ranger",
 trControl  = train_ctrl,
 tuneGrid   = tune_grid,
 num.trees  = 500,
 importance = "impurity"
)

print(rf_model)
plot(rf_model)
varImp(rf_model)

stopCluster(cl)
saveRDS(rf_model, file = "big_score_rf_model.rds")
```


--- 

## Recherche de corrélation poussé (utilisation de modèle etc...)

### <modèle>
#### optimisation des paramètres
#### mesure qualité

---

## Synthèse
